9a34c9bedc9d1706d67ff175f4045979
"use strict";
/**
 * Mocks pour l'API GitHub (Octokit)
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.mockOctokit = mockOctokit;
exports.mockGitHubClient = mockGitHubClient;
const mock_github_1 = require("../mock-github");
const jest_mock_extended_1 = require("jest-mock-extended");
/**
 * Crée un mock pour Octokit
 */
function mockOctokit(options = {}) {
    const { defaultIssueCount = 5, customResponses = {} } = options;
    // Créer une implémentation partielle de Octokit avec les méthodes mockeés
    const octokitMock = {
        rest: {
            repos: {
                get: jest.fn().mockImplementation(async () => ({
                    data: {
                        id: 123456,
                        name: 'test-repo',
                        full_name: 'test-owner/test-repo',
                        private: false,
                        owner: {
                            login: 'test-owner',
                            id: 12345,
                            type: 'User'
                        },
                        html_url: 'https://github.com/test-owner/test-repo',
                        description: 'A test repository for unit tests',
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString(),
                        ...customResponses.repo
                    },
                    status: 200,
                    headers: {},
                    url: 'https://api.github.com/repos/test-owner/test-repo'
                }))
            },
            issues: {
                listForRepo: jest.fn().mockImplementation(async () => ({
                    data: customResponses.issues?.list || (0, mock_github_1.createMockIssueList)(defaultIssueCount),
                    status: 200,
                    headers: {},
                    url: 'https://api.github.com/repos/test-owner/test-repo/issues'
                })),
                get: jest.fn().mockImplementation(async ({ issue_number }) => ({
                    data: customResponses.issues?.get?.[issue_number] || (0, mock_github_1.createMockIssue)(issue_number, `Issue ${issue_number}`),
                    status: 200,
                    headers: {},
                    url: `https://api.github.com/repos/test-owner/test-repo/issues/${issue_number}`
                })),
                create: jest.fn().mockImplementation(async ({ title, body, ...options }) => ({
                    data: (0, mock_github_1.createMockIssue)(Date.now(), title, { body, ...options }),
                    status: 201,
                    headers: {},
                    url: 'https://api.github.com/repos/test-owner/test-repo/issues'
                })),
                update: jest.fn().mockImplementation(async ({ issue_number, ...updates }) => ({
                    data: (0, mock_github_1.createMockIssue)(issue_number, `Updated Issue ${issue_number}`, updates),
                    status: 200,
                    headers: {},
                    url: `https://api.github.com/repos/test-owner/test-repo/issues/${issue_number}`
                }))
            }
        },
        graphql: jest.fn().mockImplementation(async (query, variables) => {
            // Si une réponse personnalisée est fournie pour cette requête, l'utiliser
            const queryKey = query.replace(/\s+/g, ' ').trim();
            if (customResponses.graphql?.[queryKey]) {
                return customResponses.graphql[queryKey](variables);
            }
            // Réponse par défaut
            return {
                repository: {
                    id: 'R_123456',
                    name: 'test-repo',
                    owner: { login: 'test-owner' },
                    issues: {
                        nodes: (0, mock_github_1.createMockIssueList)(3)
                    }
                }
            };
        })
    };
    return octokitMock;
}
/**
 * Crée un mock pour GitHubClient
 */
function mockGitHubClient(options = {}) {
    const clientMock = (0, jest_mock_extended_1.mock)();
    const mockIssueList = options.customResponses?.issues?.list || (0, mock_github_1.createMockIssueList)(options.defaultIssueCount || 5);
    // Mock pour getRepository
    clientMock.getRepository.mockResolvedValue({
        id: 123456,
        name: 'test-repo',
        full_name: 'test-owner/test-repo',
        private: false,
        owner: {
            login: 'test-owner',
            id: 12345,
            type: 'User'
        },
        html_url: 'https://github.com/test-owner/test-repo',
        description: 'A test repository for unit tests',
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString(),
        ...options.customResponses?.repo
    });
    // Mock pour listIssues
    clientMock.listIssues.mockResolvedValue(mockIssueList);
    // Mock pour getIssue
    clientMock.getIssue.mockImplementation(async (issueNumber) => {
        const customIssue = options.customResponses?.issues?.get?.[issueNumber];
        if (customIssue)
            return customIssue;
        const issue = mockIssueList.find((i) => i.number === issueNumber);
        if (issue)
            return issue;
        return (0, mock_github_1.createMockIssue)(issueNumber, `Issue ${issueNumber}`);
    });
    // Mock pour createIssue
    clientMock.createIssue.mockImplementation(async (title, body, opts) => (0, mock_github_1.createMockIssue)(Date.now(), title, { body, ...opts }));
    // Mock pour updateIssue
    clientMock.updateIssue.mockImplementation(async (issueNumber, updates) => (0, mock_github_1.createMockIssue)(issueNumber, `Updated Issue ${issueNumber}`, updates));
    // Mock pour graphql
    clientMock.graphql.mockImplementation(async (query, variables) => {
        // Si une réponse personnalisée est fournie pour cette requête, l'utiliser
        const queryKey = query.replace(/\s+/g, ' ').trim();
        if (options.customResponses?.graphql?.[queryKey]) {
            return options.customResponses.graphql[queryKey](variables);
        }
        // Réponse par défaut
        return {
            repository: {
                id: 'R_123456',
                name: 'test-repo',
                owner: { login: 'test-owner' },
                issues: {
                    nodes: (0, mock_github_1.createMockIssueList)(3)
                }
            }
        };
    });
    return clientMock;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL3N0ZXBoYW5lc291cm9uL2Rldi9iZWRkeS1ieWUtc3Rvcmllcy9naHAtY29ubmVjdG9yL3NyYy9saWIvdGVzdC1oZWxwZXJzL21vY2tzL29jdG9raXQtbW9jay50cyIsIm1hcHBpbmdzIjoiO0FBQUE7O0dBRUc7O0FBb0JILGtDQXFGQztBQTBCRCw0Q0FvRUM7QUFuTUQsZ0RBQXdGO0FBQ3hGLDJEQUFxRDtBQVlyRDs7R0FFRztBQUNILFNBQWdCLFdBQVcsQ0FBQyxVQUE4QixFQUFFO0lBQzFELE1BQU0sRUFBRSxpQkFBaUIsR0FBRyxDQUFDLEVBQUUsZUFBZSxHQUFHLEVBQUUsRUFBRSxHQUFHLE9BQU8sQ0FBQztJQUVoRSwwRUFBMEU7SUFDMUUsTUFBTSxXQUFXLEdBQUc7UUFDbEIsSUFBSSxFQUFFO1lBQ0osS0FBSyxFQUFFO2dCQUNMLEdBQUcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsa0JBQWtCLENBQUMsS0FBSyxJQUFJLEVBQUUsQ0FBQyxDQUFDO29CQUM3QyxJQUFJLEVBQUU7d0JBQ0osRUFBRSxFQUFFLE1BQU07d0JBQ1YsSUFBSSxFQUFFLFdBQVc7d0JBQ2pCLFNBQVMsRUFBRSxzQkFBc0I7d0JBQ2pDLE9BQU8sRUFBRSxLQUFLO3dCQUNkLEtBQUssRUFBRTs0QkFDTCxLQUFLLEVBQUUsWUFBWTs0QkFDbkIsRUFBRSxFQUFFLEtBQUs7NEJBQ1QsSUFBSSxFQUFFLE1BQU07eUJBQ2I7d0JBQ0QsUUFBUSxFQUFFLHlDQUF5Qzt3QkFDbkQsV0FBVyxFQUFFLGtDQUFrQzt3QkFDL0MsVUFBVSxFQUFFLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO3dCQUNwQyxVQUFVLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7d0JBQ3BDLEdBQUcsZUFBZSxDQUFDLElBQUk7cUJBQ3hCO29CQUNELE1BQU0sRUFBRSxHQUFHO29CQUNYLE9BQU8sRUFBRSxFQUFFO29CQUNYLEdBQUcsRUFBRSxtREFBbUQ7aUJBQ3pELENBQUMsQ0FBQzthQUNKO1lBQ0QsTUFBTSxFQUFFO2dCQUNOLFdBQVcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsa0JBQWtCLENBQUMsS0FBSyxJQUFJLEVBQUUsQ0FBQyxDQUFDO29CQUNyRCxJQUFJLEVBQUUsZUFBZSxDQUFDLE1BQU0sRUFBRSxJQUFJLElBQUksSUFBQSxpQ0FBbUIsRUFBQyxpQkFBaUIsQ0FBQztvQkFDNUUsTUFBTSxFQUFFLEdBQUc7b0JBQ1gsT0FBTyxFQUFFLEVBQUU7b0JBQ1gsR0FBRyxFQUFFLDBEQUEwRDtpQkFDaEUsQ0FBQyxDQUFDO2dCQUNILEdBQUcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsa0JBQWtCLENBQUMsS0FBSyxFQUFFLEVBQUUsWUFBWSxFQUE0QixFQUFFLEVBQUUsQ0FBQyxDQUFDO29CQUN2RixJQUFJLEVBQUUsZUFBZSxDQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FBQyxZQUFZLENBQUMsSUFBSSxJQUFBLDZCQUFlLEVBQUMsWUFBWSxFQUFFLFNBQVMsWUFBWSxFQUFFLENBQUM7b0JBQzNHLE1BQU0sRUFBRSxHQUFHO29CQUNYLE9BQU8sRUFBRSxFQUFFO29CQUNYLEdBQUcsRUFBRSw0REFBNEQsWUFBWSxFQUFFO2lCQUNoRixDQUFDLENBQUM7Z0JBQ0gsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxrQkFBa0IsQ0FBQyxLQUFLLEVBQUUsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLEdBQUcsT0FBTyxFQUlwRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO29CQUNMLElBQUksRUFBRSxJQUFBLDZCQUFlLEVBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxFQUFFLEtBQUssRUFBRSxFQUFFLElBQUksRUFBRSxHQUFHLE9BQU8sRUFBRSxDQUFDO29CQUM5RCxNQUFNLEVBQUUsR0FBRztvQkFDWCxPQUFPLEVBQUUsRUFBRTtvQkFDWCxHQUFHLEVBQUUsMERBQTBEO2lCQUNoRSxDQUFDLENBQUM7Z0JBQ0gsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxrQkFBa0IsQ0FBQyxLQUFLLEVBQUUsRUFBRSxZQUFZLEVBQUUsR0FBRyxPQUFPLEVBR3JFLEVBQUUsRUFBRSxDQUFDLENBQUM7b0JBQ0wsSUFBSSxFQUFFLElBQUEsNkJBQWUsRUFBQyxZQUFZLEVBQUUsaUJBQWlCLFlBQVksRUFBRSxFQUFFLE9BQU8sQ0FBQztvQkFDN0UsTUFBTSxFQUFFLEdBQUc7b0JBQ1gsT0FBTyxFQUFFLEVBQUU7b0JBQ1gsR0FBRyxFQUFFLDREQUE0RCxZQUFZLEVBQUU7aUJBQ2hGLENBQUMsQ0FBQzthQUNKO1NBQ0Y7UUFDRCxPQUFPLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGtCQUFrQixDQUFDLEtBQUssRUFBRSxLQUFhLEVBQUUsU0FBK0IsRUFBRSxFQUFFO1lBQzdGLDBFQUEwRTtZQUMxRSxNQUFNLFFBQVEsR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNuRCxJQUFJLGVBQWUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDO2dCQUN4QyxPQUFPLGVBQWUsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDdEQsQ0FBQztZQUVELHFCQUFxQjtZQUNyQixPQUFPO2dCQUNMLFVBQVUsRUFBRTtvQkFDVixFQUFFLEVBQUUsVUFBVTtvQkFDZCxJQUFJLEVBQUUsV0FBVztvQkFDakIsS0FBSyxFQUFFLEVBQUUsS0FBSyxFQUFFLFlBQVksRUFBRTtvQkFDOUIsTUFBTSxFQUFFO3dCQUNOLEtBQUssRUFBRSxJQUFBLGlDQUFtQixFQUFDLENBQUMsQ0FBQztxQkFDOUI7aUJBQ0Y7YUFDRixDQUFDO1FBQ0osQ0FBQyxDQUFDO0tBQ0gsQ0FBQztJQUVGLE9BQU8sV0FBaUMsQ0FBQztBQUMzQyxDQUFDO0FBdUJEOztHQUVHO0FBQ0gsU0FBZ0IsZ0JBQWdCLENBQUMsVUFBOEIsRUFBRTtJQUMvRCxNQUFNLFVBQVUsR0FBRyxJQUFBLHlCQUFJLEdBQWdCLENBQUM7SUFDeEMsTUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDLGVBQWUsRUFBRSxNQUFNLEVBQUUsSUFBSSxJQUFJLElBQUEsaUNBQW1CLEVBQUMsT0FBTyxDQUFDLGlCQUFpQixJQUFJLENBQUMsQ0FBQyxDQUFDO0lBRW5ILDBCQUEwQjtJQUMxQixVQUFVLENBQUMsYUFBYSxDQUFDLGlCQUFpQixDQUFDO1FBQ3pDLEVBQUUsRUFBRSxNQUFNO1FBQ1YsSUFBSSxFQUFFLFdBQVc7UUFDakIsU0FBUyxFQUFFLHNCQUFzQjtRQUNqQyxPQUFPLEVBQUUsS0FBSztRQUNkLEtBQUssRUFBRTtZQUNMLEtBQUssRUFBRSxZQUFZO1lBQ25CLEVBQUUsRUFBRSxLQUFLO1lBQ1QsSUFBSSxFQUFFLE1BQU07U0FDYjtRQUNELFFBQVEsRUFBRSx5Q0FBeUM7UUFDbkQsV0FBVyxFQUFFLGtDQUFrQztRQUMvQyxVQUFVLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7UUFDcEMsVUFBVSxFQUFFLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO1FBQ3BDLEdBQUcsT0FBTyxDQUFDLGVBQWUsRUFBRSxJQUFJO0tBQ2pDLENBQUMsQ0FBQztJQUVILHVCQUF1QjtJQUN2QixVQUFVLENBQUMsVUFBVSxDQUFDLGlCQUFpQixDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBRXZELHFCQUFxQjtJQUNyQixVQUFVLENBQUMsUUFBUSxDQUFDLGtCQUFrQixDQUFDLEtBQUssRUFBRSxXQUFtQixFQUFFLEVBQUU7UUFDbkUsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLGVBQWUsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDeEUsSUFBSSxXQUFXO1lBQUUsT0FBTyxXQUFXLENBQUM7UUFFcEMsTUFBTSxLQUFLLEdBQUcsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQVksRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sS0FBSyxXQUFXLENBQUMsQ0FBQztRQUM3RSxJQUFJLEtBQUs7WUFBRSxPQUFPLEtBQUssQ0FBQztRQUV4QixPQUFPLElBQUEsNkJBQWUsRUFBQyxXQUFXLEVBQUUsU0FBUyxXQUFXLEVBQUUsQ0FBQyxDQUFDO0lBQzlELENBQUMsQ0FBQyxDQUFDO0lBRUgsd0JBQXdCO0lBQ3hCLFVBQVUsQ0FBQyxXQUFXLENBQUMsa0JBQWtCLENBQUMsS0FBSyxFQUFFLEtBQWEsRUFBRSxJQUFhLEVBQUUsSUFBVSxFQUFFLEVBQUUsQ0FDM0YsSUFBQSw2QkFBZSxFQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsRUFBRSxLQUFLLEVBQUUsRUFBRSxJQUFJLEVBQUUsR0FBRyxJQUFJLEVBQUUsQ0FBQyxDQUN0RCxDQUFDO0lBRUYsd0JBQXdCO0lBQ3hCLFVBQVUsQ0FBQyxXQUFXLENBQUMsa0JBQWtCLENBQUMsS0FBSyxFQUFFLFdBQW1CLEVBQUUsT0FBWSxFQUFFLEVBQUUsQ0FDcEYsSUFBQSw2QkFBZSxFQUFDLFdBQVcsRUFBRSxpQkFBaUIsV0FBVyxFQUFFLEVBQUUsT0FBTyxDQUFDLENBQ3RFLENBQUM7SUFFRixvQkFBb0I7SUFDcEIsVUFBVSxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxLQUFLLEVBQUUsS0FBYSxFQUFFLFNBQStCLEVBQUUsRUFBRTtRQUM3RiwwRUFBMEU7UUFDMUUsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDbkQsSUFBSSxPQUFPLENBQUMsZUFBZSxFQUFFLE9BQU8sRUFBRSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUM7WUFDakQsT0FBTyxPQUFPLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUM5RCxDQUFDO1FBRUQscUJBQXFCO1FBQ3JCLE9BQU87WUFDTCxVQUFVLEVBQUU7Z0JBQ1YsRUFBRSxFQUFFLFVBQVU7Z0JBQ2QsSUFBSSxFQUFFLFdBQVc7Z0JBQ2pCLEtBQUssRUFBRSxFQUFFLEtBQUssRUFBRSxZQUFZLEVBQUU7Z0JBQzlCLE1BQU0sRUFBRTtvQkFDTixLQUFLLEVBQUUsSUFBQSxpQ0FBbUIsRUFBQyxDQUFDLENBQUM7aUJBQzlCO2FBQ0Y7U0FDRixDQUFDO0lBQ0osQ0FBQyxDQUFDLENBQUM7SUFFSCxPQUFPLFVBQVUsQ0FBQztBQUNwQixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9zdGVwaGFuZXNvdXJvbi9kZXYvYmVkZHktYnllLXN0b3JpZXMvZ2hwLWNvbm5lY3Rvci9zcmMvbGliL3Rlc3QtaGVscGVycy9tb2Nrcy9vY3Rva2l0LW1vY2sudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBNb2NrcyBwb3VyIGwnQVBJIEdpdEh1YiAoT2N0b2tpdClcbiAqL1xuXG5pbXBvcnQgeyBPY3Rva2l0IH0gZnJvbSAnb2N0b2tpdCc7XG5pbXBvcnQgeyBHaXRIdWJDbGllbnQgfSBmcm9tICcuLi8uLi9naXRodWIvY2xpZW50JztcbmltcG9ydCB7IGNyZWF0ZU1vY2tJc3N1ZSwgY3JlYXRlTW9ja0lzc3VlTGlzdCwgTW9ja0lzc3VlT3B0aW9ucyB9IGZyb20gJy4uL21vY2stZ2l0aHViJztcbmltcG9ydCB7IG1vY2ssIE1vY2tQcm94eSB9IGZyb20gJ2plc3QtbW9jay1leHRlbmRlZCc7XG5cbi8qKlxuICogT3B0aW9ucyBwb3VyIGxlIG1vY2sgT2N0b2tpdFxuICovXG5leHBvcnQgaW50ZXJmYWNlIE9jdG9raXRNb2NrT3B0aW9ucyB7XG4gIC8qKiBOb21icmUgZCdpc3N1ZXMgw6AgY3LDqWVyIHBhciBkw6lmYXV0ICovXG4gIGRlZmF1bHRJc3N1ZUNvdW50PzogbnVtYmVyO1xuICAvKiogUsOpcG9uc2VzIHBlcnNvbm5hbGlzw6llcyBwb3VyIGxlcyByZXF1w6p0ZXMgKi9cbiAgY3VzdG9tUmVzcG9uc2VzPzogUmVjb3JkPHN0cmluZywgYW55Pjtcbn1cblxuLyoqXG4gKiBDcsOpZSB1biBtb2NrIHBvdXIgT2N0b2tpdFxuICovXG5leHBvcnQgZnVuY3Rpb24gbW9ja09jdG9raXQob3B0aW9uczogT2N0b2tpdE1vY2tPcHRpb25zID0ge30pIHtcbiAgY29uc3QgeyBkZWZhdWx0SXNzdWVDb3VudCA9IDUsIGN1c3RvbVJlc3BvbnNlcyA9IHt9IH0gPSBvcHRpb25zO1xuICBcbiAgLy8gQ3LDqWVyIHVuZSBpbXBsw6ltZW50YXRpb24gcGFydGllbGxlIGRlIE9jdG9raXQgYXZlYyBsZXMgbcOpdGhvZGVzIG1vY2tlw6lzXG4gIGNvbnN0IG9jdG9raXRNb2NrID0ge1xuICAgIHJlc3Q6IHtcbiAgICAgIHJlcG9zOiB7XG4gICAgICAgIGdldDogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbihhc3luYyAoKSA9PiAoe1xuICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgIGlkOiAxMjM0NTYsXG4gICAgICAgICAgICBuYW1lOiAndGVzdC1yZXBvJyxcbiAgICAgICAgICAgIGZ1bGxfbmFtZTogJ3Rlc3Qtb3duZXIvdGVzdC1yZXBvJyxcbiAgICAgICAgICAgIHByaXZhdGU6IGZhbHNlLFxuICAgICAgICAgICAgb3duZXI6IHtcbiAgICAgICAgICAgICAgbG9naW46ICd0ZXN0LW93bmVyJyxcbiAgICAgICAgICAgICAgaWQ6IDEyMzQ1LFxuICAgICAgICAgICAgICB0eXBlOiAnVXNlcidcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBodG1sX3VybDogJ2h0dHBzOi8vZ2l0aHViLmNvbS90ZXN0LW93bmVyL3Rlc3QtcmVwbycsXG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogJ0EgdGVzdCByZXBvc2l0b3J5IGZvciB1bml0IHRlc3RzJyxcbiAgICAgICAgICAgIGNyZWF0ZWRfYXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgICAgIHVwZGF0ZWRfYXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgICAgIC4uLmN1c3RvbVJlc3BvbnNlcy5yZXBvXG4gICAgICAgICAgfSxcbiAgICAgICAgICBzdGF0dXM6IDIwMCxcbiAgICAgICAgICBoZWFkZXJzOiB7fSxcbiAgICAgICAgICB1cmw6ICdodHRwczovL2FwaS5naXRodWIuY29tL3JlcG9zL3Rlc3Qtb3duZXIvdGVzdC1yZXBvJ1xuICAgICAgICB9KSlcbiAgICAgIH0sXG4gICAgICBpc3N1ZXM6IHtcbiAgICAgICAgbGlzdEZvclJlcG86IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oYXN5bmMgKCkgPT4gKHtcbiAgICAgICAgICBkYXRhOiBjdXN0b21SZXNwb25zZXMuaXNzdWVzPy5saXN0IHx8IGNyZWF0ZU1vY2tJc3N1ZUxpc3QoZGVmYXVsdElzc3VlQ291bnQpLFxuICAgICAgICAgIHN0YXR1czogMjAwLFxuICAgICAgICAgIGhlYWRlcnM6IHt9LFxuICAgICAgICAgIHVybDogJ2h0dHBzOi8vYXBpLmdpdGh1Yi5jb20vcmVwb3MvdGVzdC1vd25lci90ZXN0LXJlcG8vaXNzdWVzJ1xuICAgICAgICB9KSksXG4gICAgICAgIGdldDogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbihhc3luYyAoeyBpc3N1ZV9udW1iZXIgfTogeyBpc3N1ZV9udW1iZXI6IG51bWJlciB9KSA9PiAoe1xuICAgICAgICAgIGRhdGE6IGN1c3RvbVJlc3BvbnNlcy5pc3N1ZXM/LmdldD8uW2lzc3VlX251bWJlcl0gfHwgY3JlYXRlTW9ja0lzc3VlKGlzc3VlX251bWJlciwgYElzc3VlICR7aXNzdWVfbnVtYmVyfWApLFxuICAgICAgICAgIHN0YXR1czogMjAwLFxuICAgICAgICAgIGhlYWRlcnM6IHt9LFxuICAgICAgICAgIHVybDogYGh0dHBzOi8vYXBpLmdpdGh1Yi5jb20vcmVwb3MvdGVzdC1vd25lci90ZXN0LXJlcG8vaXNzdWVzLyR7aXNzdWVfbnVtYmVyfWBcbiAgICAgICAgfSkpLFxuICAgICAgICBjcmVhdGU6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oYXN5bmMgKHsgdGl0bGUsIGJvZHksIC4uLm9wdGlvbnMgfTogeyBcbiAgICAgICAgICB0aXRsZTogc3RyaW5nOyBcbiAgICAgICAgICBib2R5Pzogc3RyaW5nOyBcbiAgICAgICAgICBba2V5OiBzdHJpbmddOiBhbnkgXG4gICAgICAgIH0pID0+ICh7XG4gICAgICAgICAgZGF0YTogY3JlYXRlTW9ja0lzc3VlKERhdGUubm93KCksIHRpdGxlLCB7IGJvZHksIC4uLm9wdGlvbnMgfSksXG4gICAgICAgICAgc3RhdHVzOiAyMDEsXG4gICAgICAgICAgaGVhZGVyczoge30sXG4gICAgICAgICAgdXJsOiAnaHR0cHM6Ly9hcGkuZ2l0aHViLmNvbS9yZXBvcy90ZXN0LW93bmVyL3Rlc3QtcmVwby9pc3N1ZXMnXG4gICAgICAgIH0pKSxcbiAgICAgICAgdXBkYXRlOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKGFzeW5jICh7IGlzc3VlX251bWJlciwgLi4udXBkYXRlcyB9OiB7IFxuICAgICAgICAgIGlzc3VlX251bWJlcjogbnVtYmVyO1xuICAgICAgICAgIFtrZXk6IHN0cmluZ106IGFueVxuICAgICAgICB9KSA9PiAoe1xuICAgICAgICAgIGRhdGE6IGNyZWF0ZU1vY2tJc3N1ZShpc3N1ZV9udW1iZXIsIGBVcGRhdGVkIElzc3VlICR7aXNzdWVfbnVtYmVyfWAsIHVwZGF0ZXMpLFxuICAgICAgICAgIHN0YXR1czogMjAwLFxuICAgICAgICAgIGhlYWRlcnM6IHt9LFxuICAgICAgICAgIHVybDogYGh0dHBzOi8vYXBpLmdpdGh1Yi5jb20vcmVwb3MvdGVzdC1vd25lci90ZXN0LXJlcG8vaXNzdWVzLyR7aXNzdWVfbnVtYmVyfWBcbiAgICAgICAgfSkpXG4gICAgICB9XG4gICAgfSxcbiAgICBncmFwaHFsOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKGFzeW5jIChxdWVyeTogc3RyaW5nLCB2YXJpYWJsZXM/OiBSZWNvcmQ8c3RyaW5nLCBhbnk+KSA9PiB7XG4gICAgICAvLyBTaSB1bmUgcsOpcG9uc2UgcGVyc29ubmFsaXPDqWUgZXN0IGZvdXJuaWUgcG91ciBjZXR0ZSByZXF1w6p0ZSwgbCd1dGlsaXNlclxuICAgICAgY29uc3QgcXVlcnlLZXkgPSBxdWVyeS5yZXBsYWNlKC9cXHMrL2csICcgJykudHJpbSgpO1xuICAgICAgaWYgKGN1c3RvbVJlc3BvbnNlcy5ncmFwaHFsPy5bcXVlcnlLZXldKSB7XG4gICAgICAgIHJldHVybiBjdXN0b21SZXNwb25zZXMuZ3JhcGhxbFtxdWVyeUtleV0odmFyaWFibGVzKTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgLy8gUsOpcG9uc2UgcGFyIGTDqWZhdXRcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHJlcG9zaXRvcnk6IHtcbiAgICAgICAgICBpZDogJ1JfMTIzNDU2JyxcbiAgICAgICAgICBuYW1lOiAndGVzdC1yZXBvJyxcbiAgICAgICAgICBvd25lcjogeyBsb2dpbjogJ3Rlc3Qtb3duZXInIH0sXG4gICAgICAgICAgaXNzdWVzOiB7XG4gICAgICAgICAgICBub2RlczogY3JlYXRlTW9ja0lzc3VlTGlzdCgzKVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfTtcbiAgICB9KVxuICB9O1xuICBcbiAgcmV0dXJuIG9jdG9raXRNb2NrIGFzIHVua25vd24gYXMgT2N0b2tpdDtcbn1cblxuLy8gVHlwZSBwb3VyIGxlcyBpc3N1ZXMgcmVudm95w6llcyBwYXIgbGUgbW9ja1xuaW50ZXJmYWNlIE1vY2tJc3N1ZSB7XG4gIGlkOiBudW1iZXI7XG4gIG51bWJlcjogbnVtYmVyO1xuICB0aXRsZTogc3RyaW5nO1xuICBib2R5OiBzdHJpbmc7XG4gIHN0YXRlOiBzdHJpbmc7XG4gIGh0bWxfdXJsOiBzdHJpbmc7XG4gIGxhYmVsczogQXJyYXk8eyBpZDogbnVtYmVyLCBuYW1lOiBzdHJpbmcsIGNvbG9yOiBzdHJpbmcgfT47XG4gIGFzc2lnbmVlczogQXJyYXk8eyBsb2dpbjogc3RyaW5nLCBpZDogbnVtYmVyIH0+O1xuICBjcmVhdGVkX2F0OiBzdHJpbmc7XG4gIHVwZGF0ZWRfYXQ6IHN0cmluZztcbiAgY2xvc2VkX2F0OiBzdHJpbmcgfCBudWxsO1xuICB1c2VyOiB7XG4gICAgbG9naW46IHN0cmluZztcbiAgICBpZDogbnVtYmVyO1xuICAgIGF2YXRhcl91cmw6IHN0cmluZztcbiAgICBodG1sX3VybDogc3RyaW5nO1xuICB9O1xufVxuXG4vKipcbiAqIENyw6llIHVuIG1vY2sgcG91ciBHaXRIdWJDbGllbnRcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIG1vY2tHaXRIdWJDbGllbnQob3B0aW9uczogT2N0b2tpdE1vY2tPcHRpb25zID0ge30pOiBNb2NrUHJveHk8R2l0SHViQ2xpZW50PiAmIEdpdEh1YkNsaWVudCB7XG4gIGNvbnN0IGNsaWVudE1vY2sgPSBtb2NrPEdpdEh1YkNsaWVudD4oKTtcbiAgY29uc3QgbW9ja0lzc3VlTGlzdCA9IG9wdGlvbnMuY3VzdG9tUmVzcG9uc2VzPy5pc3N1ZXM/Lmxpc3QgfHwgY3JlYXRlTW9ja0lzc3VlTGlzdChvcHRpb25zLmRlZmF1bHRJc3N1ZUNvdW50IHx8IDUpO1xuICBcbiAgLy8gTW9jayBwb3VyIGdldFJlcG9zaXRvcnlcbiAgY2xpZW50TW9jay5nZXRSZXBvc2l0b3J5Lm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICBpZDogMTIzNDU2LFxuICAgIG5hbWU6ICd0ZXN0LXJlcG8nLFxuICAgIGZ1bGxfbmFtZTogJ3Rlc3Qtb3duZXIvdGVzdC1yZXBvJyxcbiAgICBwcml2YXRlOiBmYWxzZSxcbiAgICBvd25lcjoge1xuICAgICAgbG9naW46ICd0ZXN0LW93bmVyJyxcbiAgICAgIGlkOiAxMjM0NSxcbiAgICAgIHR5cGU6ICdVc2VyJ1xuICAgIH0sXG4gICAgaHRtbF91cmw6ICdodHRwczovL2dpdGh1Yi5jb20vdGVzdC1vd25lci90ZXN0LXJlcG8nLFxuICAgIGRlc2NyaXB0aW9uOiAnQSB0ZXN0IHJlcG9zaXRvcnkgZm9yIHVuaXQgdGVzdHMnLFxuICAgIGNyZWF0ZWRfYXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICB1cGRhdGVkX2F0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgLi4ub3B0aW9ucy5jdXN0b21SZXNwb25zZXM/LnJlcG9cbiAgfSk7XG4gIFxuICAvLyBNb2NrIHBvdXIgbGlzdElzc3Vlc1xuICBjbGllbnRNb2NrLmxpc3RJc3N1ZXMubW9ja1Jlc29sdmVkVmFsdWUobW9ja0lzc3VlTGlzdCk7XG4gIFxuICAvLyBNb2NrIHBvdXIgZ2V0SXNzdWVcbiAgY2xpZW50TW9jay5nZXRJc3N1ZS5tb2NrSW1wbGVtZW50YXRpb24oYXN5bmMgKGlzc3VlTnVtYmVyOiBudW1iZXIpID0+IHtcbiAgICBjb25zdCBjdXN0b21Jc3N1ZSA9IG9wdGlvbnMuY3VzdG9tUmVzcG9uc2VzPy5pc3N1ZXM/LmdldD8uW2lzc3VlTnVtYmVyXTtcbiAgICBpZiAoY3VzdG9tSXNzdWUpIHJldHVybiBjdXN0b21Jc3N1ZTtcbiAgICBcbiAgICBjb25zdCBpc3N1ZSA9IG1vY2tJc3N1ZUxpc3QuZmluZCgoaTogTW9ja0lzc3VlKSA9PiBpLm51bWJlciA9PT0gaXNzdWVOdW1iZXIpO1xuICAgIGlmIChpc3N1ZSkgcmV0dXJuIGlzc3VlO1xuICAgIFxuICAgIHJldHVybiBjcmVhdGVNb2NrSXNzdWUoaXNzdWVOdW1iZXIsIGBJc3N1ZSAke2lzc3VlTnVtYmVyfWApO1xuICB9KTtcbiAgXG4gIC8vIE1vY2sgcG91ciBjcmVhdGVJc3N1ZVxuICBjbGllbnRNb2NrLmNyZWF0ZUlzc3VlLm1vY2tJbXBsZW1lbnRhdGlvbihhc3luYyAodGl0bGU6IHN0cmluZywgYm9keT86IHN0cmluZywgb3B0cz86IGFueSkgPT4gXG4gICAgY3JlYXRlTW9ja0lzc3VlKERhdGUubm93KCksIHRpdGxlLCB7IGJvZHksIC4uLm9wdHMgfSlcbiAgKTtcbiAgXG4gIC8vIE1vY2sgcG91ciB1cGRhdGVJc3N1ZVxuICBjbGllbnRNb2NrLnVwZGF0ZUlzc3VlLm1vY2tJbXBsZW1lbnRhdGlvbihhc3luYyAoaXNzdWVOdW1iZXI6IG51bWJlciwgdXBkYXRlczogYW55KSA9PiBcbiAgICBjcmVhdGVNb2NrSXNzdWUoaXNzdWVOdW1iZXIsIGBVcGRhdGVkIElzc3VlICR7aXNzdWVOdW1iZXJ9YCwgdXBkYXRlcylcbiAgKTtcbiAgXG4gIC8vIE1vY2sgcG91ciBncmFwaHFsXG4gIGNsaWVudE1vY2suZ3JhcGhxbC5tb2NrSW1wbGVtZW50YXRpb24oYXN5bmMgKHF1ZXJ5OiBzdHJpbmcsIHZhcmlhYmxlcz86IFJlY29yZDxzdHJpbmcsIGFueT4pID0+IHtcbiAgICAvLyBTaSB1bmUgcsOpcG9uc2UgcGVyc29ubmFsaXPDqWUgZXN0IGZvdXJuaWUgcG91ciBjZXR0ZSByZXF1w6p0ZSwgbCd1dGlsaXNlclxuICAgIGNvbnN0IHF1ZXJ5S2V5ID0gcXVlcnkucmVwbGFjZSgvXFxzKy9nLCAnICcpLnRyaW0oKTtcbiAgICBpZiAob3B0aW9ucy5jdXN0b21SZXNwb25zZXM/LmdyYXBocWw/LltxdWVyeUtleV0pIHtcbiAgICAgIHJldHVybiBvcHRpb25zLmN1c3RvbVJlc3BvbnNlcy5ncmFwaHFsW3F1ZXJ5S2V5XSh2YXJpYWJsZXMpO1xuICAgIH1cbiAgICBcbiAgICAvLyBSw6lwb25zZSBwYXIgZMOpZmF1dFxuICAgIHJldHVybiB7XG4gICAgICByZXBvc2l0b3J5OiB7XG4gICAgICAgIGlkOiAnUl8xMjM0NTYnLFxuICAgICAgICBuYW1lOiAndGVzdC1yZXBvJyxcbiAgICAgICAgb3duZXI6IHsgbG9naW46ICd0ZXN0LW93bmVyJyB9LFxuICAgICAgICBpc3N1ZXM6IHtcbiAgICAgICAgICBub2RlczogY3JlYXRlTW9ja0lzc3VlTGlzdCgzKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfTtcbiAgfSk7XG4gIFxuICByZXR1cm4gY2xpZW50TW9jaztcbn0gIl0sInZlcnNpb24iOjN9