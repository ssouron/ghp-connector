b5811f0abd058c97126f3fd8d83d96ba
"use strict";
/**
 * Configuration Manager
 * Handles loading and merging configuration from different sources
 */
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.CONFIG_FILENAME = void 0;
exports.findConfigFile = findConfigFile;
exports.loadConfigFile = loadConfigFile;
exports.getEnvConfig = getEnvConfig;
exports.mergeConfigs = mergeConfigs;
exports.cmdArgsToConfig = cmdArgsToConfig;
exports.loadConfig = loadConfig;
exports.initConfigFile = initConfigFile;
exports.getDefaultConfig = getDefaultConfig;
exports.validateConfig = validateConfig;
const fs_1 = __importDefault(require("fs"));
const path_1 = __importDefault(require("path"));
const os_1 = __importDefault(require("os"));
// Define configuration file name
exports.CONFIG_FILENAME = '.ghprc.json';
// Default configuration
const defaultConfig = {
    github: {
        owner: '',
        repo: '',
        baseUrl: 'https://api.github.com',
    },
    defaults: {
        format: 'human',
        issues: {
            state: 'open',
            limit: 10,
            sort: 'created',
            direction: 'desc',
        },
        projects: {},
    },
};
/**
 * Find and load the configuration file
 * Searches in the following locations (in order):
 * 1. Current directory (./.ghprc.json)
 * 2. User's home directory (~/.ghprc.json)
 */
function findConfigFile() {
    // Check current directory
    const currentDirConfig = path_1.default.join(process.cwd(), exports.CONFIG_FILENAME);
    if (fs_1.default.existsSync(currentDirConfig)) {
        return currentDirConfig;
    }
    // Check home directory
    const homeDirConfig = path_1.default.join(os_1.default.homedir(), exports.CONFIG_FILENAME);
    if (fs_1.default.existsSync(homeDirConfig)) {
        return homeDirConfig;
    }
    return null;
}
/**
 * Load the configuration file
 */
function loadConfigFile(filePath) {
    try {
        const configContent = fs_1.default.readFileSync(filePath, 'utf-8');
        return JSON.parse(configContent);
    }
    catch (error) {
        throw new Error(`Failed to load config file: ${error instanceof Error ? error.message : String(error)}`);
    }
}
/**
 * Get environment variable configuration
 */
function getEnvConfig() {
    const github = {};
    // Only set properties that are actually defined in environment variables
    if (process.env.GITHUB_OWNER) {
        github.owner = process.env.GITHUB_OWNER;
    }
    if (process.env.GITHUB_REPO) {
        github.repo = process.env.GITHUB_REPO;
    }
    if (process.env.GITHUB_TOKEN) {
        github.token = process.env.GITHUB_TOKEN;
    }
    if (process.env.GITHUB_API_URL) {
        github.baseUrl = process.env.GITHUB_API_URL;
    }
    // Only include github config if at least one property is set
    const envConfig = {};
    if (Object.keys(github).length > 0) {
        envConfig.github = github;
    }
    return envConfig;
}
/**
 * Merge configurations from different sources
 * Priority (highest to lowest):
 * 1. Command line arguments
 * 2. Environment variables
 * 3. Config file
 * 4. Default values
 */
function mergeConfigs(cmdConfig, envConfig, fileConfig) {
    // Start with default config
    const result = JSON.parse(JSON.stringify(defaultConfig));
    // Merge in order of priority (lowest to highest)
    return deepMerge(deepMerge(deepMerge(result, fileConfig), envConfig), cmdConfig);
}
/**
 * Deep merge two objects
 */
function deepMerge(target, source) {
    if (!source)
        return target;
    const output = { ...target };
    Object.keys(source).forEach(key => {
        const targetValue = output[key];
        const sourceValue = source[key];
        if (typeof sourceValue === 'object' &&
            sourceValue !== null &&
            !Array.isArray(sourceValue)) {
            if (typeof targetValue === 'object' &&
                targetValue !== null &&
                !Array.isArray(targetValue)) {
                output[key] = deepMerge(targetValue, sourceValue);
            }
            else {
                output[key] = { ...sourceValue };
            }
        }
        else if (sourceValue !== undefined) {
            output[key] = sourceValue;
        }
    });
    return output;
}
/**
 * Convert command-line options to config structure
 */
function cmdArgsToConfig(options) {
    const config = {};
    if (options.owner || options.repo) {
        config.github = {};
        if (options.owner) {
            config.github.owner = options.owner;
        }
        if (options.repo) {
            config.github.repo = options.repo;
        }
    }
    if (options.format) {
        if (!config.defaults) {
            config.defaults = {};
        }
        config.defaults.format = options.format;
    }
    return config;
}
/**
 * Load configuration from all sources and merge them
 */
function loadConfig(cmdArgs = {}) {
    // Load config from environment
    const envConfig = getEnvConfig();
    // Load config from file
    let fileConfig = {};
    const configPath = findConfigFile();
    if (configPath) {
        try {
            fileConfig = loadConfigFile(configPath);
        }
        catch (error) {
            console.error(`Warning: ${error instanceof Error ? error.message : String(error)}`);
        }
    }
    // Merge all configs
    return mergeConfigs(cmdArgs, envConfig, fileConfig);
}
/**
 * Create a new config file with default settings
 */
function initConfigFile(filePath) {
    try {
        const configStr = JSON.stringify(defaultConfig, null, 2);
        fs_1.default.writeFileSync(filePath, configStr, 'utf-8');
    }
    catch (error) {
        throw new Error(`Failed to create config file: ${error instanceof Error ? error.message : String(error)}`);
    }
}
/**
 * Get default configuration as a template
 */
function getDefaultConfig() {
    return JSON.parse(JSON.stringify(defaultConfig));
}
/**
 * Validate configuration
 * Returns true if valid, throws error if invalid
 */
function validateConfig(config) {
    // We'll add more validation in the future as needed
    if (config.github) {
        if (config.github.baseUrl) {
            try {
                new URL(config.github.baseUrl);
            }
            catch (error) {
                throw new Error(`Invalid baseUrl: ${config.github.baseUrl}`);
            }
        }
    }
    return true;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL3N0ZXBoYW5lc291cm9uL2Rldi9iZWRkeS1ieWUtc3Rvcmllcy9naHAtY29ubmVjdG9yL3NyYy9saWIvY29uZmlnL2luZGV4LnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7O0dBR0c7Ozs7OztBQTRESCx3Q0FjQztBQUtELHdDQU9DO0FBS0Qsb0NBMkJDO0FBVUQsb0NBVUM7QUF1Q0QsMENBdUJDO0FBS0QsZ0NBaUJDO0FBS0Qsd0NBT0M7QUFLRCw0Q0FFQztBQU1ELHdDQWFDO0FBbFFELDRDQUFvQjtBQUNwQixnREFBd0I7QUFDeEIsNENBQW9CO0FBRXBCLGlDQUFpQztBQUNwQixRQUFBLGVBQWUsR0FBRyxhQUFhLENBQUM7QUFFN0Msd0JBQXdCO0FBQ3hCLE1BQU0sYUFBYSxHQUFHO0lBQ3BCLE1BQU0sRUFBRTtRQUNOLEtBQUssRUFBRSxFQUFFO1FBQ1QsSUFBSSxFQUFFLEVBQUU7UUFDUixPQUFPLEVBQUUsd0JBQXdCO0tBQ2xDO0lBQ0QsUUFBUSxFQUFFO1FBQ1IsTUFBTSxFQUFFLE9BQU87UUFDZixNQUFNLEVBQUU7WUFDTixLQUFLLEVBQUUsTUFBTTtZQUNiLEtBQUssRUFBRSxFQUFFO1lBQ1QsSUFBSSxFQUFFLFNBQVM7WUFDZixTQUFTLEVBQUUsTUFBTTtTQUNsQjtRQUNELFFBQVEsRUFBRSxFQUFFO0tBQ2I7Q0FDRixDQUFDO0FBNEJGOzs7OztHQUtHO0FBQ0gsU0FBZ0IsY0FBYztJQUM1QiwwQkFBMEI7SUFDMUIsTUFBTSxnQkFBZ0IsR0FBRyxjQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsRUFBRSx1QkFBZSxDQUFDLENBQUM7SUFDbkUsSUFBSSxZQUFFLENBQUMsVUFBVSxDQUFDLGdCQUFnQixDQUFDLEVBQUUsQ0FBQztRQUNwQyxPQUFPLGdCQUFnQixDQUFDO0lBQzFCLENBQUM7SUFFRCx1QkFBdUI7SUFDdkIsTUFBTSxhQUFhLEdBQUcsY0FBSSxDQUFDLElBQUksQ0FBQyxZQUFFLENBQUMsT0FBTyxFQUFFLEVBQUUsdUJBQWUsQ0FB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RUFBRSxDQUFDO1FBQ2YsTUFBTSxJQUFJLEtBQUssQ0FBQyxpQ0FBaUMsS0FBSyxZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUM3RyxDQUFDO0FBQ0gsQ0FBQztBQUVEOztHQUVHO0FBQ0gsU0FBZ0IsZ0JBQWdCO0lBQzlCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLGFBQWEsQ0FBQyxDQUFjLENBQUM7QUFDaEUsQ0FBQztBQUVEOzs7R0FHRztBQUNILFNBQWdCLGNBQWMsQ0FBQyxNQUEwQjtJQUN2RCxvREFBb0Q7SUFDcEQsSUFBSSxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDbEIsSUFBSSxNQUFNLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQzFCLElBQUksQ0FBQztnQkFDSCxJQUFJLEdBQUcsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ2pDLENBQUM7WUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO2dCQUNmLE1BQU0sSUFBSSxLQUFLLENBQUMsb0JBQW9CLE1BQU0sQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztZQUMvRCxDQUFDO1FBQ0gsQ0FBQztJQUNILENBQUM7SUFFRCxPQUFPLElBQUksQ0FBQztBQUNkLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL3N0ZXBoYW5lc291cm9uL2Rldi9iZWRkeS1ieWUtc3Rvcmllcy9naHAtY29ubmVjdG9yL3NyYy9saWIvY29uZmlnL2luZGV4LnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29uZmlndXJhdGlvbiBNYW5hZ2VyXG4gKiBIYW5kbGVzIGxvYWRpbmcgYW5kIG1lcmdpbmcgY29uZmlndXJhdGlvbiBmcm9tIGRpZmZlcmVudCBzb3VyY2VzXG4gKi9cblxuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IG9zIGZyb20gJ29zJztcblxuLy8gRGVmaW5lIGNvbmZpZ3VyYXRpb24gZmlsZSBuYW1lXG5leHBvcnQgY29uc3QgQ09ORklHX0ZJTEVOQU1FID0gJy5naHByYy5qc29uJztcblxuLy8gRGVmYXVsdCBjb25maWd1cmF0aW9uXG5jb25zdCBkZWZhdWx0Q29uZmlnID0ge1xuICBnaXRodWI6IHtcbiAgICBvd25lcjogJycsXG4gICAgcmVwbzogJycsXG4gICAgYmFzZVVybDogJ2h0dHBzOi8vYXBpLmdpdGh1Yi5jb20nLFxuICB9LFxuICBkZWZhdWx0czoge1xuICAgIGZvcm1hdDogJ2h1bWFuJyxcbiAgICBpc3N1ZXM6IHtcbiAgICAgIHN0YXRlOiAnb3BlbicsXG4gICAgICBsaW1pdDogMTAsXG4gICAgICBzb3J0OiAnY3JlYXRlZCcsXG4gICAgICBkaXJlY3Rpb246ICdkZXNjJyxcbiAgICB9LFxuICAgIHByb2plY3RzOiB7fSxcbiAgfSxcbn07XG5cbi8vIERlZmluZSBHaXRIdWIgY29uZmlnIGludGVyZmFjZVxuZXhwb3J0IGludGVyZmFjZSBHaXRIdWJDb25maWcge1xuICBvd25lcjogc3RyaW5nO1xuICByZXBvOiBzdHJpbmc7XG4gIHRva2VuPzogc3RyaW5nO1xuICBiYXNlVXJsPzogc3RyaW5nO1xufVxuXG4vLyBEZWZpbmUgY29uZmlndXJhdGlvbiBpbnRlcmZhY2VcbmV4cG9ydCBpbnRlcmZhY2UgR0hQQ29uZmlnIHtcbiAgZ2l0aHViOiBHaXRIdWJDb25maWc7XG4gIGRlZmF1bHRzOiB7XG4gICAgZm9ybWF0OiAnaHVtYW4nIHwgJ2pzb24nIHwgJ3RhYmxlJyB8ICdtaW5pbWFsJztcbiAgICBpc3N1ZXM6IHtcbiAgICAgIHN0YXRlOiBzdHJpbmc7XG4gICAgICBsaW1pdD86IG51bWJlcjtcbiAgICAgIHNvcnQ/OiBzdHJpbmc7XG4gICAgICBkaXJlY3Rpb24/OiBzdHJpbmc7XG4gICAgICBba2V5OiBzdHJpbmddOiBhbnk7XG4gICAgfTtcbiAgICBwcm9qZWN0czoge1xuICAgICAgW2tleTogc3RyaW5nXTogYW55O1xuICAgIH07XG4gIH07XG59XG5cbi8qKlxuICogRmluZCBhbmQgbG9hZCB0aGUgY29uZmlndXJhdGlvbiBmaWxlXG4gKiBTZWFyY2hlcyBpbiB0aGUgZm9sbG93aW5nIGxvY2F0aW9ucyAoaW4gb3JkZXIpOlxuICogMS4gQ3VycmVudCBkaXJlY3RvcnkgKC4vLmdocHJjLmpzb24pXG4gKiAyLiBVc2VyJ3MgaG9tZSBkaXJlY3RvcnkgKH4vLmdocHJjLmpzb24pXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBmaW5kQ29uZmlnRmlsZSgpOiBzdHJpbmcgfCBudWxsIHtcbiAgLy8gQ2hlY2sgY3VycmVudCBkaXJlY3RvcnlcbiAgY29uc3QgY3VycmVudERpckNvbmZpZyA9IHBhdGguam9pbihwcm9jZXNzLmN3ZCgpLCBDT05GSUdfRklMRU5BTUUpO1xuICBpZiAoZnMuZXhpc3RzU3luYyhjdXJyZW50RGlyQ29uZmlnKSkge1xuICAgIHJldHVybiBjdXJyZW50RGlyQ29uZmlnO1xuICB9XG5cbiAgLy8gQ2hlY2sgaG9tZSBkaXJlY3RvcnlcbiAgY29uc3QgaG9tZURpckNvbmZpZyA9IHBhdGguam9pbihvcy5ob21lZGlyKCksIENPTkZJR19GSUxFTkFNRSk7XG4gIGlmIChmcy5leGlzdHNTeW5jKGhvbWVEaXJDb25maWcpKSB7XG4gICAgcmV0dXJuIGhvbWVEaXJDb25maWc7XG4gIH1cblxuICByZXR1cm4gbnVsbDtcbn1cblxuLyoqXG4gKiBMb2FkIHRoZSBjb25maWd1cmF0aW9uIGZpbGVcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGxvYWRDb25maWdGaWxlKGZpbGVQYXRoOiBzdHJpbmcpOiBQYXJ0aWFsPEdIUENvbmZpZz4ge1xuICB0cnkge1xuICAgIGNvbnN0IGNvbmZpZ0NvbnRlbnQgPSBmcy5yZWFkRmlsZVN5bmMoZmlsZVBhdGgsICd1dGYtOCcpO1xuICAgIHJldHVybiBKU09OLnBhcnNlKGNvbmZpZ0NvbnRlbnQpIGFzIFBhcnRpYWw8R0hQQ29uZmlnPjtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byBsb2FkIGNvbmZpZyBmaWxlOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKX1gKTtcbiAgfVxufVxuXG4vKipcbiAqIEdldCBlbnZpcm9ubWVudCB2YXJpYWJsZSBjb25maWd1cmF0aW9uXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRFbnZDb25maWcoKTogUGFydGlhbDxHSFBDb25maWc+IHtcbiAgY29uc3QgZ2l0aHViOiBQYXJ0aWFsPEdpdEh1YkNvbmZpZz4gPSB7fTtcbiAgXG4gIC8vIE9ubHkgc2V0IHByb3BlcnRpZXMgdGhhdCBhcmUgYWN0dWFsbHkgZGVmaW5lZCBpbiBlbnZpcm9ubWVudCB2YXJpYWJsZXNcbiAgaWYgKHByb2Nlc3MuZW52LkdJVEhVQl9PV05FUikge1xuICAgIGdpdGh1Yi5vd25lciA9IHByb2Nlc3MuZW52LkdJVEhVQl9PV05FUjtcbiAgfVxuICBcbiAgaWYgKHByb2Nlc3MuZW52LkdJVEhVQl9SRVBPKSB7XG4gICAgZ2l0aHViLnJlcG8gPSBwcm9jZXNzLmVudi5HSVRIVUJfUkVQTztcbiAgfVxuICBcbiAgaWYgKHByb2Nlc3MuZW52LkdJVEhVQl9UT0tFTikge1xuICAgIGdpdGh1Yi50b2tlbiA9IHByb2Nlc3MuZW52LkdJVEhVQl9UT0tFTjtcbiAgfVxuICBcbiAgaWYgKHByb2Nlc3MuZW52LkdJVEhVQl9BUElfVVJMKSB7XG4gICAgZ2l0aHViLmJhc2VVcmwgPSBwcm9jZXNzLmVudi5HSVRIVUJfQVBJX1VSTDtcbiAgfVxuICBcbiAgLy8gT25seSBpbmNsdWRlIGdpdGh1YiBjb25maWcgaWYgYXQgbGVhc3Qgb25lIHByb3BlcnR5IGlzIHNldFxuICBjb25zdCBlbnZDb25maWc6IFBhcnRpYWw8R0hQQ29uZmlnPiA9IHt9O1xuICBpZiAoT2JqZWN0LmtleXMoZ2l0aHViKS5sZW5ndGggPiAwKSB7XG4gICAgZW52Q29uZmlnLmdpdGh1YiA9IGdpdGh1YiBhcyBHaXRIdWJDb25maWc7XG4gIH1cbiAgXG4gIHJldHVybiBlbnZDb25maWc7XG59XG5cbi8qKlxuICogTWVyZ2UgY29uZmlndXJhdGlvbnMgZnJvbSBkaWZmZXJlbnQgc291cmNlc1xuICogUHJpb3JpdHkgKGhpZ2hlc3QgdG8gbG93ZXN0KTpcbiAqIDEuIENvbW1hbmQgbGluZSBhcmd1bWVudHNcbiAqIDIuIEVudmlyb25tZW50IHZhcmlhYmxlc1xuICogMy4gQ29uZmlnIGZpbGVcbiAqIDQuIERlZmF1bHQgdmFsdWVzXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBtZXJnZUNvbmZpZ3MoXG4gIGNtZENvbmZpZzogUGFydGlhbDxHSFBDb25maWc+LFxuICBlbnZDb25maWc6IFBhcnRpYWw8R0hQQ29uZmlnPixcbiAgZmlsZUNvbmZpZzogUGFydGlhbDxHSFBDb25maWc+LFxuKTogR0hQQ29uZmlnIHtcbiAgLy8gU3RhcnQgd2l0aCBkZWZhdWx0IGNvbmZpZ1xuICBjb25zdCByZXN1bHQgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGRlZmF1bHRDb25maWcpKSBhcyBHSFBDb25maWc7XG4gIFxuICAvLyBNZXJnZSBpbiBvcmRlciBvZiBwcmlvcml0eSAobG93ZXN0IHRvIGhpZ2hlc3QpXG4gIHJldHVybiBkZWVwTWVyZ2UoZGVlcE1lcmdlKGRlZXBNZXJnZShyZXN1bHQsIGZpbGVDb25maWcpLCBlbnZDb25maWcpLCBjbWRDb25maWcpO1xufVxuXG4vKipcbiAqIERlZXAgbWVyZ2UgdHdvIG9iamVjdHNcbiAqL1xuZnVuY3Rpb24gZGVlcE1lcmdlPFQ+KHRhcmdldDogVCwgc291cmNlOiBQYXJ0aWFsPFQ+KTogVCB7XG4gIGlmICghc291cmNlKSByZXR1cm4gdGFyZ2V0O1xuICBcbiAgY29uc3Qgb3V0cHV0ID0geyAuLi50YXJnZXQgfTtcbiAgXG4gIE9iamVjdC5rZXlzKHNvdXJjZSkuZm9yRWFjaChrZXkgPT4ge1xuICAgIGNvbnN0IHRhcmdldFZhbHVlID0gKG91dHB1dCBhcyBhbnkpW2tleV07XG4gICAgY29uc3Qgc291cmNlVmFsdWUgPSAoc291cmNlIGFzIGFueSlba2V5XTtcbiAgICBcbiAgICBpZiAoXG4gICAgICB0eXBlb2Ygc291cmNlVmFsdWUgPT09ICdvYmplY3QnICYmIFxuICAgICAgc291cmNlVmFsdWUgIT09IG51bGwgJiYgXG4gICAgICAhQXJyYXkuaXNBcnJheShzb3VyY2VWYWx1ZSlcbiAgICApIHtcbiAgICAgIGlmIChcbiAgICAgICAgdHlwZW9mIHRhcmdldFZhbHVlID09PSAnb2JqZWN0JyAmJiBcbiAgICAgICAgdGFyZ2V0VmFsdWUgIT09IG51bGwgJiYgXG4gICAgICAgICFBcnJheS5pc0FycmF5KHRhcmdldFZhbHVlKVxuICAgICAgKSB7XG4gICAgICAgIChvdXRwdXQgYXMgYW55KVtrZXldID0gZGVlcE1lcmdlKHRhcmdldFZhbHVlLCBzb3VyY2VWYWx1ZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAob3V0cHV0IGFzIGFueSlba2V5XSA9IHsgLi4uc291cmNlVmFsdWUgfTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKHNvdXJjZVZhbHVlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIChvdXRwdXQgYXMgYW55KVtrZXldID0gc291cmNlVmFsdWU7XG4gICAgfVxuICB9KTtcbiAgXG4gIHJldHVybiBvdXRwdXQ7XG59XG5cbi8qKlxuICogQ29udmVydCBjb21tYW5kLWxpbmUgb3B0aW9ucyB0byBjb25maWcgc3RydWN0dXJlXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjbWRBcmdzVG9Db25maWcob3B0aW9uczogYW55KTogUGFydGlhbDxHSFBDb25maWc+IHtcbiAgY29uc3QgY29uZmlnOiBQYXJ0aWFsPEdIUENvbmZpZz4gPSB7fTtcbiAgXG4gIGlmIChvcHRpb25zLm93bmVyIHx8IG9wdGlvbnMucmVwbykge1xuICAgIGNvbmZpZy5naXRodWIgPSB7fSBhcyBHaXRIdWJDb25maWc7XG4gICAgXG4gICAgaWYgKG9wdGlvbnMub3duZXIpIHtcbiAgICAgIGNvbmZpZy5naXRodWIub3duZXIgPSBvcHRpb25zLm93bmVyO1xuICAgIH1cbiAgICBcbiAgICBpZiAob3B0aW9ucy5yZXBvKSB7XG4gICAgICBjb25maWcuZ2l0aHViLnJlcG8gPSBvcHRpb25zLnJlcG87XG4gICAgfVxuICB9XG4gIFxuICBpZiAob3B0aW9ucy5mb3JtYXQpIHtcbiAgICBpZiAoIWNvbmZpZy5kZWZhdWx0cykge1xuICAgICAgY29uZmlnLmRlZmF1bHRzID0ge30gYXMgR0hQQ29uZmlnWydkZWZhdWx0cyddO1xuICAgIH1cbiAgICBjb25maWcuZGVmYXVsdHMuZm9ybWF0ID0gb3B0aW9ucy5mb3JtYXQ7XG4gIH1cbiAgXG4gIHJldHVybiBjb25maWc7XG59XG5cbi8qKlxuICogTG9hZCBjb25maWd1cmF0aW9uIGZyb20gYWxsIHNvdXJjZXMgYW5kIG1lcmdlIHRoZW1cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGxvYWRDb25maWcoY21kQXJnczogUGFydGlhbDxHSFBDb25maWc+ID0ge30pOiBHSFBDb25maWcge1xuICAvLyBMb2FkIGNvbmZpZyBmcm9tIGVudmlyb25tZW50XG4gIGNvbnN0IGVudkNvbmZpZyA9IGdldEVudkNvbmZpZygpO1xuICBcbiAgLy8gTG9hZCBjb25maWcgZnJvbSBmaWxlXG4gIGxldCBmaWxlQ29uZmlnOiBQYXJ0aWFsPEdIUENvbmZpZz4gPSB7fTtcbiAgY29uc3QgY29uZmlnUGF0aCA9IGZpbmRDb25maWdGaWxlKCk7XG4gIGlmIChjb25maWdQYXRoKSB7XG4gICAgdHJ5IHtcbiAgICAgIGZpbGVDb25maWcgPSBsb2FkQ29uZmlnRmlsZShjb25maWdQYXRoKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihgV2FybmluZzogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcil9YCk7XG4gICAgfVxuICB9XG4gIFxuICAvLyBNZXJnZSBhbGwgY29uZmlnc1xuICByZXR1cm4gbWVyZ2VDb25maWdzKGNtZEFyZ3MsIGVudkNvbmZpZywgZmlsZUNvbmZpZyk7XG59XG5cbi8qKlxuICogQ3JlYXRlIGEgbmV3IGNvbmZpZyBmaWxlIHdpdGggZGVmYXVsdCBzZXR0aW5nc1xuICovXG5leHBvcnQgZnVuY3Rpb24gaW5pdENvbmZpZ0ZpbGUoZmlsZVBhdGg6IHN0cmluZyk6IHZvaWQge1xuICB0cnkge1xuICAgIGNvbnN0IGNvbmZpZ1N0ciA9IEpTT04uc3RyaW5naWZ5KGRlZmF1bHRDb25maWcsIG51bGwsIDIpO1xuICAgIGZzLndyaXRlRmlsZVN5bmMoZmlsZVBhdGgsIGNvbmZpZ1N0ciwgJ3V0Zi04Jyk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gY3JlYXRlIGNvbmZpZyBmaWxlOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKX1gKTtcbiAgfVxufVxuXG4vKipcbiAqIEdldCBkZWZhdWx0IGNvbmZpZ3VyYXRpb24gYXMgYSB0ZW1wbGF0ZVxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0RGVmYXVsdENvbmZpZygpOiBHSFBDb25maWcge1xuICByZXR1cm4gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShkZWZhdWx0Q29uZmlnKSkgYXMgR0hQQ29uZmlnO1xufVxuXG4vKipcbiAqIFZhbGlkYXRlIGNvbmZpZ3VyYXRpb25cbiAqIFJldHVybnMgdHJ1ZSBpZiB2YWxpZCwgdGhyb3dzIGVycm9yIGlmIGludmFsaWRcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHZhbGlkYXRlQ29uZmlnKGNvbmZpZzogUGFydGlhbDxHSFBDb25maWc+KTogYm9vbGVhbiB7XG4gIC8vIFdlJ2xsIGFkZCBtb3JlIHZhbGlkYXRpb24gaW4gdGhlIGZ1dHVyZSBhcyBuZWVkZWRcbiAgaWYgKGNvbmZpZy5naXRodWIpIHtcbiAgICBpZiAoY29uZmlnLmdpdGh1Yi5iYXNlVXJsKSB7XG4gICAgICB0cnkge1xuICAgICAgICBuZXcgVVJMKGNvbmZpZy5naXRodWIuYmFzZVVybCk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgYmFzZVVybDogJHtjb25maWcuZ2l0aHViLmJhc2VVcmx9YCk7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIFxuICByZXR1cm4gdHJ1ZTtcbn0gIl0sInZlcnNpb24iOjN9